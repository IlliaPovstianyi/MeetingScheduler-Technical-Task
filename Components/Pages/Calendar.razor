@page "/calendar"
@attribute [Authorize]
@rendermode InteractiveServer
@inject IUserService UserService
@inject IHolidayService HolidayService
@inject NavigationManager NavigationManager

<PageTitle>Kalendář</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="home-container">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="logo-section">
                    <img src="/images/scio-logo.png" alt="SCIO Logo" class="logo" />
                </div>
                <div class="profile-section">
                    <span class="profile-name">@CurrentUser?.FirstName @CurrentUser?.LastName</span>
                    @if (!string.IsNullOrEmpty(CurrentUser?.ProfilePictureUrl))
                    {
                        <img src="@CurrentUser.ProfilePictureUrl" alt="Profil" class="profile-avatar" />
                    }
                    else
                    {
                        <div class="profile-avatar-placeholder">
                            @CurrentUser?.FirstName?.FirstOrDefault()
                        </div>
                    }
                    <a href="/logout" class="logout-link" title="Odhlásit se">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </a>
                </div>
            </header>

            <!-- Main Content -->
            <main class="content-wrapper">
                <div class="welcome-section animate-appear">
                    <h1 class="welcome-text">Můj kalendář</h1>
                    <p class="subtitle-text">Prohlédněte si své naplánované schůzky a spravujte svou dostupnost</p>
                </div>

                <div class="calendar-card animate-appear" style="animation-delay: 0.1s;">
                    <!-- Calendar Navigation -->
                    <div class="calendar-nav">
                        <button class="nav-btn back-btn" @onclick="GoHome">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                            Zpět
                        </button>

                        <div class="nav-center">
                            <button class="arrow-btn" @onclick="PreviousMonth" title="Předchozí měsíc">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>

                            <div class="date-selectors">
                                <select class="date-select" @bind="SelectedMonth" @bind:after="OnDateChanged">
                                    @foreach (var month in Months)
                                    {
                                        <option value="@month.Value">@month.Name</option>
                                    }
                                </select>
                                <select class="date-select" @bind="SelectedYear" @bind:after="OnDateChanged">
                                    @foreach (var year in Years)
                                    {
                                        <option value="@year">@year</option>
                                    }
                                </select>
                            </div>

                            <button class="arrow-btn" @onclick="NextMonth" title="Další měsíc">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                        </div>

                        <button class="nav-btn today-btn" @onclick="GoToToday">
                            Dnes
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="calendar-grid">
                        <!-- Day Headers -->
                        <div class="day-header">Po</div>
                        <div class="day-header">Út</div>
                        <div class="day-header">St</div>
                        <div class="day-header">Čt</div>
                        <div class="day-header">Pá</div>
                        <div class="day-header weekend">So</div>
                        <div class="day-header weekend">Ne</div>

                        <!-- Calendar Days -->
                        @foreach (var day in CalendarDays)
                        {
                            <div class="@GetDayClasses(day)" @onclick="() => OnDayClick(day)">
                                @if (day.Date.HasValue)
                                {
                                    <span class="day-number">@day.Date.Value.Day</span>
                                    @if (day.BookingCount > 0)
                                    {
                                        <span class="meeting-count">@day.BookingCount</span>
                                    }
                                    @if (day.IsFullyBooked)
                                    {
                                        <span class="day-indicator booked"></span>
                                    }
                                    @if (day.IsHoliday)
                                    {
                                        <span class="day-indicator holiday"></span>
                                    }
                                }
                            </div>
                        }
                    </div>

                    <!-- Legend -->
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <span class="legend-dot has-meeting"></span>
                            <span class="legend-text">Schůzky</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot holiday-dot"></span>
                            <span class="legend-text">Svátek</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot weekend-dot"></span>
                            <span class="legend-text">Víkend</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Meeting Modal -->
        @if (ShowMeetingModal && SelectedDay != null)
        {
            <div class="modal-overlay" @onclick="CloseMeetingModal">
                <div class="modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h2>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            @SelectedDay.Value.ToString("d. MMMM yyyy", new System.Globalization.CultureInfo("cs-CZ"))
                        </h2>
                        <button class="modal-close" @onclick="CloseMeetingModal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        @if (SelectedDayMeetings.Any())
                        {
                            <div class="meetings-list">
                                @foreach (var meeting in SelectedDayMeetings.OrderBy(m => m.StartTime))
                                {
                                    <div class="meeting-item">
                                        <div class="meeting-time-badge">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <polyline points="12 6 12 12 16 14"></polyline>
                                            </svg>
                                            @meeting.StartTime.ToString(@"hh\:mm") - @meeting.EndTime.ToString(@"hh\:mm")
                                        </div>
                                        <div class="meeting-details">
                                            <div class="meeting-guest">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                    <circle cx="12" cy="7" r="4"></circle>
                                                </svg>
                                                <span>@meeting.GuestFirstName @meeting.GuestLastName</span>
                                            </div>
                                            <div class="meeting-duration">
                                                @{
                                                    var duration = meeting.EndTime - meeting.StartTime;
                                                    var minutes = (int)duration.TotalMinutes;
                                                }
                                                <span class="duration-badge">@minutes min</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="no-meetings">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                    <line x1="9" y1="16" x2="15" y2="16"></line>
                                </svg>
                                <p>Na tento den nemáte naplánované žádné schůzky</p>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" @onclick="CloseMeetingModal">Zavřít</button>
                    </div>
                </div>
            </div>
        }
    </Authorized>
</AuthorizeView>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private User? CurrentUser { get; set; }

    private int SelectedMonth { get; set; }
    private int SelectedYear { get; set; }

    private List<CalendarDay> CalendarDays { get; set; } = new();
    private List<(int Value, string Name)> Months { get; set; } = new();
    private List<int> Years { get; set; } = new();

    // Modal state
    private bool ShowMeetingModal { get; set; } = false;
    private DateTime? SelectedDay { get; set; }
    private List<Meeting> SelectedDayMeetings { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            CurrentUser = await UserService.GetUserFromClaims(authState.User);
        }

        InitializeMonths();
        InitializeYears();

        var today = DateTime.Today;
        SelectedMonth = today.Month;
        SelectedYear = today.Year;

        GenerateCalendarDays();
    }

    private void InitializeMonths()
    {
        Months = new List<(int, string)>
        {
            (1, "Leden"),
            (2, "Únor"),
            (3, "Březen"),
            (4, "Duben"),
            (5, "Květen"),
            (6, "Červen"),
            (7, "Červenec"),
            (8, "Srpen"),
            (9, "Září"),
            (10, "Říjen"),
            (11, "Listopad"),
            (12, "Prosinec")
        };
    }

    private void InitializeYears()
    {
        var currentYear = DateTime.Today.Year;
        Years = Enumerable.Range(currentYear - 5, 11).ToList();
    }

    private void GenerateCalendarDays()
    {
        CalendarDays.Clear();

        var firstDayOfMonth = new DateTime(SelectedYear, SelectedMonth, 1);
        var daysInMonth = DateTime.DaysInMonth(SelectedYear, SelectedMonth);

        // Get the day of week (Monday = 0, Sunday = 6)
        var startDayOfWeek = ((int)firstDayOfMonth.DayOfWeek + 6) % 7;

        // Add empty days for previous month
        for (int i = 0; i < startDayOfWeek; i++)
        {
            CalendarDays.Add(new CalendarDay { Date = null });
        }

        // Add days of current month
        for (int day = 1; day <= daysInMonth; day++)
        {
            var date = new DateTime(SelectedYear, SelectedMonth, day);
            var meetingsOnDay = GetMeetingsForDate(date);
            
            CalendarDays.Add(new CalendarDay
            {
                Date = date,
                IsToday = date == DateTime.Today,
                IsWeekend = date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday,
                IsFullyBooked = false,
                IsHoliday = HolidayService.IsHoliday(date),
                HasMeeting = meetingsOnDay.Any(),
                BookingCount = meetingsOnDay.Count,
                IsPast = date < DateTime.Today
            });
        }

        // Add empty days to complete the last week
        var remainingDays = 7 - (CalendarDays.Count % 7);
        if (remainingDays < 7)
        {
            for (int i = 0; i < remainingDays; i++)
            {
                CalendarDays.Add(new CalendarDay { Date = null });
            }
        }
    }

    private List<Meeting> GetMeetingsForDate(DateTime date)
    {
        if (CurrentUser?.Meetings == null)
            return new List<Meeting>();

        return CurrentUser.Meetings
            .Where(m => m.Date.Date == date.Date)
            .ToList();
    }

    private string GetDayClasses(CalendarDay day)
    {
        var classes = new List<string> { "calendar-day" };

        if (!day.Date.HasValue)
        {
            classes.Add("empty");
            return string.Join(" ", classes);
        }

        if (day.IsToday) classes.Add("today");
        if (day.IsWeekend) classes.Add("weekend");
        if (day.IsFullyBooked) classes.Add("booked");
        if (day.IsHoliday) classes.Add("holiday");
        if (day.HasMeeting) classes.Add("has-meeting");
        if (day.IsPast) classes.Add("past");

        return string.Join(" ", classes);
    }

    private void OnDateChanged()
    {
        GenerateCalendarDays();
    }

    private void PreviousMonth()
    {
        if (SelectedMonth == 1)
        {
            SelectedMonth = 12;
            SelectedYear--;
            if (!Years.Contains(SelectedYear))
            {
                Years.Insert(0, SelectedYear);
            }
        }
        else
        {
            SelectedMonth--;
        }
        GenerateCalendarDays();
    }

    private void NextMonth()
    {
        if (SelectedMonth == 12)
        {
            SelectedMonth = 1;
            SelectedYear++;
            if (!Years.Contains(SelectedYear))
            {
                Years.Add(SelectedYear);
            }
        }
        else
        {
            SelectedMonth++;
        }
        GenerateCalendarDays();
    }

    private void GoToToday()
    {
        var today = DateTime.Today;
        SelectedMonth = today.Month;
        SelectedYear = today.Year;
        GenerateCalendarDays();
    }

    private void GoHome()
    {
        NavigationManager.NavigateTo("/", forceLoad: true);
    }

    private void OnDayClick(CalendarDay day)
    {
        if (day.Date.HasValue)
        {
            SelectedDay = day.Date.Value;
            SelectedDayMeetings = GetMeetingsForDate(day.Date.Value);
            ShowMeetingModal = true;
        }
    }

    private void CloseMeetingModal()
    {
        ShowMeetingModal = false;
        SelectedDay = null;
        SelectedDayMeetings.Clear();
    }
}
