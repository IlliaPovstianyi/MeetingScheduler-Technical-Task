@page "/"
@using System.Threading.Tasks
@using MeetingScheduler_Technical_Task.Components.Pages
@attribute [Authorize]
@rendermode InteractiveServer
@inject IUserService UserService
@inject IBookingService BookingService
@inject IJSRuntime JSRuntime

<PageTitle>Home</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="home-container">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="logo-section">
                    <img src="/images/scio-logo.png" alt="SCIO Logo" class="logo" />
                </div>
                <div class="profile-section">
                    <span class="profile-name">@CurrentUser?.FirstName @CurrentUser?.LastName</span>
                    @if (!string.IsNullOrEmpty(CurrentUser?.ProfilePictureUrl))
                    {
                        <img src="@CurrentUser.ProfilePictureUrl" alt="Profil" class="profile-avatar" />
                    }
                    else
                    {
                        <div class="profile-avatar-placeholder">
                            @CurrentUser?.FirstName?.FirstOrDefault()
                        </div>
                    }
                    <a href="/logout" class="logout-link" title="Odhlásit se">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </a>
                </div>
            </header>

            <!-- Main Content -->
            <main class="content-wrapper">
                <div class="welcome-section animate-appear">
                    <h1 class="welcome-text">Vítejte zpět!</h1>
                    <p class="subtitle-text">Spravujte své schůzky a sdílejte svůj kalendář</p>
                </div>

                <div class="cards-container">
                    <!-- Calendar Card -->
                    <div class="action-card animate-appear" style="animation-delay: 0.1s;">
                        <div class="card-emoji">📅</div>
                        <h2 class="card-title">Můj kalendář</h2>
                        <p class="card-description">Prohlédněte si své naplánované schůzky a spravujte svou dostupnost</p>
                        <button @onclick="ShowCalendar" class="card-btn">
                            Zobrazit kalendář
                        </button>
                    </div>

                    <!-- Share Link Card -->
                    <div class="action-card animate-appear" style="animation-delay: 0.2s;">
                        <div class="card-emoji">🔗</div>
                        <h2 class="card-title">Sdílet odkaz</h2>
                        <p class="card-description">Vygenerujte unikátní odkaz pro sjednání jednorázové schůzky</p>
                        
                        @if (string.IsNullOrEmpty(GeneratedLink))
                        {
                            <button @onclick="GenerateNewLink" class="card-btn">
                                Vygenerovat odkaz
                            </button>
                        }
                        else
                        {
                            <div class="link-container">
                                <input type="text" readonly value="@GeneratedLink" class="link-input" />
                                <button @onclick="CopyLink" class="copy-btn" title="Kopírovat odkaz">
                                    @if (IsCopied)
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                    }
                                </button>
                            </div>
                            <button @onclick="GenerateNewLink" class="card-btn card-btn-secondary">
                                Vygenerovat nový odkaz
                            </button>
                        }
                    </div>
                </div>
            </main>
        </div>
    </Authorized>
</AuthorizeView>


@inject NavigationManager NavigationManager

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private User? CurrentUser { get; set; }
    private string? GeneratedLink { get; set; }
    private bool IsCopied { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;

            CurrentUser = await UserService.GetUserFromClaims(authState.User);
        }
    }

    private void ShowCalendar()
    {
        NavigationManager.NavigateTo("/calendar", forceLoad: true);
    }

    private async Task GenerateNewLink()
    {
        if (CurrentUser == null) return;

        GeneratedLink = null;
        IsCopied = false;

        string bookingLink = await BookingService.GenerateBookingLink(CurrentUser);

        //TODO: Add error handling if link is not generated;
        if(bookingLink == null) return;

        string baseUrl = NavigationManager.BaseUri.TrimEnd('/');
        GeneratedLink = $"{baseUrl}/{bookingLink}";
    }

    private async Task CopyLink()
    {
        if (!string.IsNullOrEmpty(GeneratedLink))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", GeneratedLink);
            IsCopied = true;
            StateHasChanged();
            
            // Reset the copied state after 2 seconds
            await Task.Delay(2000);
            IsCopied = false;
            StateHasChanged();
        }
    }
}
